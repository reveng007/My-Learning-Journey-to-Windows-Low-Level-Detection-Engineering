# Dissecting FlawedAmmyy (Trognization of AmmyAdmin Remote Admin Tool): Static Analysis via IDA (only checking out code flow, Api usage, etc)

## 1. Open sample in IDA (with load resources option as we have already seen that resources section might contain something malicious)

<img width="638" height="463" alt="image" src="https://github.com/user-attachments/assets/d64f0969-7cab-4d5c-9a50-be33cf383812" />

## 2. Checking out strings in IDA: `shift + F12`

<img width="2879" height="1285" alt="image" src="https://github.com/user-attachments/assets/81855b67-c023-4097-8692-c27e5380005e" />

## 3. Under IAT table (Imports): Let's investigate `CreateToolHelp32SnapShot`

<img width="572" height="90" alt="image" src="https://github.com/user-attachments/assets/03e0e32f-bc7b-4863-9324-1f24d1902e69" />

### We can see `.Idata` Section in IDA. But, we can see this section is not a part of the SectionHeader of PE. Then why present here ?

> ### IDA adds it's own section as `.Idata` section which helps to store RE progess in IDB file.

| 1 | 2 |
| - | - |
| <img width="846" height="120" alt="image" src="https://github.com/user-attachments/assets/ebdecdf2-9b83-4020-9024-a7e351ba8cb9" /> | <img width="980" height="491" alt="image" src="https://github.com/user-attachments/assets/f0051ba6-8107-4613-a95b-84ec92ebb46d" /> |

## 4. Checking where `CreateToolHelp32SnapShot` API is used/called in the code: Select the API and press `X`.

<img width="1041" height="522" alt="image" src="https://github.com/user-attachments/assets/98fc828b-b201-4ad7-9e9d-206e7fa4379b" />

### Double Click to see the code.

<img width="1495" height="619" alt="image" src="https://github.com/user-attachments/assets/37c0782a-3ee5-471b-94e8-b1ec02649911" />

### Click `space` bar to change code view.

### We see the starting address of the API as well (`40264E`) and the function/subroutine which calls this process Enumeration Trio is `sub_402640`
<img width="1062" height="696" alt="image" src="https://github.com/user-attachments/assets/6f915953-8140-4b39-be59-63c569fe2c48" /> 

#### We can see all the three functions here in this view working as a loop mechanism to perform process enumeration. 
<img width="868" height="684" alt="image" src="https://github.com/user-attachments/assets/be5202ff-cb23-42cd-8a3e-b23c3cf6d655" />
<img width="843" height="692" alt="image" src="https://github.com/user-attachments/assets/3c194b9c-7585-43b3-8f4d-973a08a226a0" />

## 5. Checking upon `sub_402640` (process enumerating subroutine): We can see that it is called more than once.

<img width="819" height="585" alt="image" src="https://github.com/user-attachments/assets/522b796f-dcbf-44aa-90e3-26bbbf7e688b" />

### Inspecting one of the Instances of the call of `sub_402640`

| 1 | 2 |
| - | - |
| We can see several calls of same subroutine. <img width="785" height="697" alt="image" src="https://github.com/user-attachments/assets/7230f67e-fdd6-4e64-9d1c-07120a194c38" /> | We can see several calls of same subroutine. <img width="906" height="685" alt="image" src="https://github.com/user-attachments/assets/617b5311-a64c-41f9-9e5e-135b3aed00e6" /> |

### At the very end, it get's divided into 2 parts. If `test eax, eax` is not zero it will jump to `part 1` Block of code else (if not zero), it will jump to `part 2` Block of code. 
> ### JNZ is short for "Jump if not zero (ZF = 0)"

<img width="1293" height="818" alt="image" src="https://github.com/user-attachments/assets/d822bcec-e8de-4d9f-b280-a53353a949ac" />

### We can see two process names, `EKRN.exe` and `EGUI.exe` which is a part of ESET AV, meaning, it is trying to Enumerate Processes to know whether there is any AV or EDR processes running or not.

### May be they are trying to execute in those systems where AVs are not present, or they don't want to share this sample with AV/EDR Vendors, etc...

## 6. To Rename function names, select subroutine and press `N`. Now, We can go to Functions Window and press `Ctrl + F` to search for function/subroutine names we want to search.

<img width="592" height="796" alt="image" src="https://github.com/user-attachments/assets/6e56e32c-bedd-41a4-b8aa-256075e1a879" />


